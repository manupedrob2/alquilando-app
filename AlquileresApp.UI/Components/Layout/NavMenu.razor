@namespace AlquileresApp.UI.Components.Layout
@inherits ComponentBase
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Authorization
@using AlquileresApp.Core.Servicios
@using AlquileresApp.Core.CasosDeUso.Usuario
@inject NavigationManager NavigationManager
@inject ServicioAutenticacion ServicioAutenticacion
@inject IUsuarioRepositorio UsuarioRepositorio
@inject CasoDeUsoCerrarSesion CUCerrarSesion
@using System.Security.Claims
@using AlquileresApp.Core.Entidades
@using AlquileresApp.Core.Interfaces
@using AlquileresApp.Core.CasosDeUso.PreguntasFrecuentes
@rendermode InteractiveServer

<!-- Scripts necesarios (Tailwind, FontAwesome y fuente Poppins) -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

@if (isDropdownOpen)
{
    <div class="fixed inset-0 z-40 bg-transparent" @onclick="CerrarDropdown"></div>
}

<!-- NAVBAR: Fondo blanco con sombra suave -->
<nav style="background-color: #ffffff; border-bottom: 1px solid #f3f4f6; position: fixed; top: 0; left: 0; width: 100%; height: 80px; z-index: 1000; box-shadow: 0 4px 20px rgba(140, 169, 255, 0.1); display: flex; align-items: center; font-family: 'Poppins', sans-serif;">
    
    <div style="width: 100%; max-width: 1280px; margin: 0 auto; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; height: 100%;">
        
        <!-- 1. LOGO Y MARCA -->
        <a href="/" style="text-decoration: none; display: flex; align-items: center; gap: 12px;">
            <!-- Logo Circular (Estilo forzado) -->
            <div style="width: 45px; height: 45px; border-radius: 50%; overflow: hidden; display: flex; justify-content: center; align-items: center; border: 2px solid #f3f4f6;">
                <img src="/images/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            
            <!-- Texto Marca: Azul Pastel (#8CA9FF) -->
            <span style="color: #8CA9FF; font-weight: 700; font-size: 1.5rem; letter-spacing: -0.5px;">
                Alquilando
            </span>
        </a>

        <!-- 2. MENÚ -->
        <AuthorizeView>
            <Authorized>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <!-- Botón Modo Anfitrión: Fondo Crema (#FFF8DE) -->
                    <a href="/Administrar" class="hidden md:block" style="text-decoration: none; background-color: #FFF8DE; color: #6b7280; font-weight: 500; font-size: 0.9rem; padding: 8px 20px; border-radius: 9999px; transition: background 0.2s;">
                        Modo Anfitrión
                    </a>

                    <!-- Menú Usuario -->
                    <div class="relative">
                        <button style="border: 1px solid #e5e7eb; background: white; padding: 5px 5px 5px 12px; border-radius: 9999px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: box-shadow 0.2s;"
                                onmouseover="this.style.boxShadow='0 4px 10px rgba(0,0,0,0.05)'"
                                onmouseout="this.style.boxShadow='none'"
                                @onclick:stopPropagation @onclick="ToggleDropdown">
                            
                            <i class="fa-solid fa-bars text-gray-400" style="font-size: 14px;"></i>
                            
                            <!-- Avatar: Fondo Azul Pastel -->
                            <div style="width: 32px; height: 32px; background-color: #8CA9FF; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;">
                                @context.User.Identity?.Name?.Substring(0, 1).ToUpper()
                            </div>
                        </button>

                        <!-- Dropdown -->
                        @if (isDropdownOpen)
                        {
                            <div class="absolute right-0 top-full mt-2 w-64 bg-white rounded-2xl shadow-[0_10px_30px_-5px_rgba(140,169,255,0.25)] border border-gray-100 py-2 flex flex-col z-50 overflow-hidden">
                                <div class="px-5 py-4 border-b border-gray-50 bg-[#FFF8DE] bg-opacity-50">
                                    <p class="text-sm font-bold text-gray-800 m-0">@context.User.Identity?.Name</p>
                                    <p class="text-xs text-[#8CA9FF] m-0 font-semibold">Usuario verificado</p>
                                </div>

                                <a class="px-5 py-3 text-sm text-gray-600 hover:bg-gray-50 flex items-center gap-3 no-underline" 
                                   href="/Perfil/@context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value">
                                    <i class="fa-regular fa-user w-5 text-[#8CA9FF]"></i> Mi Perfil
                                </a>

                                @if (context.User.IsInRole("Administrador"))
                                {
                                    <a class="px-5 py-3 text-sm text-gray-600 hover:bg-gray-50 flex items-center gap-3 no-underline" href="/Administrar">
                                        <i class="fa-solid fa-gear w-5 text-[#8CA9FF]"></i> Panel Admin
                                    </a>
                                }
                                
                                <div class="border-t border-gray-100 my-1"></div>

                                <button class="w-full text-left px-5 py-3 text-sm text-[#ff8fa3] hover:bg-red-50 flex items-center gap-3 font-medium bg-transparent border-0" 
                                        @onclick="CerrarSesion">
                                    <i class="fa-solid fa-arrow-right-from-bracket w-5"></i> Cerrar sesión
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </Authorized>
            
            <NotAuthorized>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="/Registro" style="text-decoration: none; color: #6b7280; font-weight: 500; font-size: 0.9rem; transition: color 0.2s;">
                        Registrarse
                    </a>
                    
                    <!-- Botón Login: Azul Pastel (#8CA9FF) -->
                    <a href="/Login" style="text-decoration: none; background-color: #8CA9FF; color: white; font-weight: 500; font-size: 0.9rem; padding: 10px 24px; border-radius: 9999px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(140, 169, 255, 0.3); transition: transform 0.1s;"
                       onmouseover="this.style.backgroundColor='#7A98EF'; this.style.transform='translateY(-1px)'"
                       onmouseout="this.style.backgroundColor='#8CA9FF'; this.style.transform='translateY(0)'">
                        <i class="fa-solid fa-user" style="font-size: 0.8rem;"></i> Iniciar Sesión
                    </a>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</nav>

<!-- Espaciador -->
<div style="height: 80px; width: 100%;"></div>

@code {
    private bool isDropdownOpen = false;

    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }

    private void CerrarDropdown()
    {
        isDropdownOpen = false;
    }

    private async Task CerrarSesion()
    {
        await CUCerrarSesion.Ejecutar();
        NavigationManager.NavigateTo("/", true);
    }
}